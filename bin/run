#!/bin/bash

PROGNAME=$(basename $0)

# ヘルプ
usage() {
  echo "Webサーバを立ち上げ、サービスを開始する"
  echo "  Usage: zenra $PROGNAME [-u username] [-p port] [-f]"
  echo "オプション"
  echo "  -u 指定したユーザ名でログイン"
  echo "  -p unicornを起動するポートを指定(デフォルト8080)"
  echo "  -f Webサーバをフォアグランド上で実行する(ログの取得をしない)"
  exit 1
}

# オプション解析
FLAG_F=0
while getopts u:p:fh OPT
do
  case $OPT in
    h)  usage
      exit 1
      ;;
    u)  VALUE_U=$OPTARG
      ;;
    p)  VALUE_P=$OPTARG
      ;;
    f)  FLAG_F=1
      ;;
  esac
done
shift $((OPTIND - 1))

# メイン処理
cd $MARCHDIR
zenra stop

if [ -n "$VALUE_U" ]; then
  bundle exec ruby "bin/scripts/set_config.rb" "set" "auto_login" "$VALUE_U"
else
  bundle exec ruby "bin/scripts/set_config.rb" "unset" "auto_login"
fi
if [ -z "$VALUE_P" ]; then
  VALUE_P=8080
fi

if [ "$FLAG_F" -eq 1 ]; then
  bundle exec unicorn --port $VALUE_P
else
  bundle exec unicorn -c unicorn.rb -D --port $VALUE_P
fi
